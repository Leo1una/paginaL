{% extends 'base.html' %} {% load ipcalc_extras %} {% block title %}Calculadora
IP{% endblock %} {% block content %}
<div class="container text-center mt-5" style="color: #e2e8f0">
	<h1 class="display-5 fw-bold mb-4 text-glow" style="color: #60a5fa">
		Calculadora IP
	</h1>

	<form method="POST" class="mt-4 mx-auto" style="max-width: 600px">
		{% csrf_token %}
		<input
			type="text"
			name="ip_input"
			placeholder="Ej: 192.168.1.0/24 o 2001:db8::/64"
			required
			class="form-control text-center mb-3" />
		<div id="ip-valid" class="small mt-1 fw-bold"></div>

		<p class="text-secondary small mb-3">
			Ejemplos válidos:
			<code>192.168.10.0/24</code>, <code>10.0.0.0/16</code>,
			<code>2001:db8::/64</code>
		</p>

		<select name="subnet_bits" class="form-select text-center mb-3">
			<option value="">Sin subneteo</option>
			{% for i in 1|to:6 %}
			<option value="{{ i }}">+{{ i }} bits</option>
			{% endfor %}
		</select>

		<button type="submit" class="btn btn-primary px-5 fw-bold shadow-lg">
			Calcular
		</button>
	</form>

	{% if data.error %}
	<p class="text-danger mt-4 fs-5 fw-semibold">{{ data.error }}</p>

	{% elif data.ip %} {% if data.clase == "IPv6" %}
	<div class="mt-4 mb-2">
		<span
			class="badge fs-6 px-4 py-2 shadow-lg glow-blue"
			style="background-color: #1e90ff; color: white; border-radius: 12px">
			Modo IPv6 activo
		</span>
	</div>
	{% elif data.clase == "IPv4" %}
	<div class="mt-4 mb-2">
		<span
			class="badge fs-6 px-4 py-2 shadow-lg glow-green"
			style="background-color: #1e90ff; color: white; border-radius: 12px">
			Modo IPv4 activo
		</span>
	</div>
	{% endif %}

	<div class="table-responsive mt-4">
		<table
			class="table table-dark table-bordered table-striped w-75 mx-auto shadow-lg"
			style="border-color: #3b82f6">
			<tr
				class="table table-dark table-hover w-75 mx-auto shadow"
				style="border-color: #2563eb">
				<th>Atributo</th>
				<th>Valor</th>
			</tr>
			<tr>
				<td>Dirección de Red</td>
				<td>{{ data.ip }}</td>
			</tr>
			<tr>
				<td>Broadcast</td>
				<td>{{ data.broadcast }}</td>
			</tr>
			<tr>
				<td>Máscara</td>
				<td>{{ data.mascara }}</td>
			</tr>
			<tr>
				<td>Prefijo CIDR</td>
				<td>/{{ data.prefijo }}</td>
			</tr>
			<tr>
				<td>Total de Hosts</td>
				<td>{{ data.total_hosts }}</td>
			</tr>
			<tr>
				<td>Rango de Hosts</td>
				<td>{{ data.rango }}</td>
			</tr>
			<tr>
				<td>Clase</td>
				<td>{{ data.clase }}</td>
			</tr>
			<tr>
				<td>Tipo</td>
				<td>{{ data.tipo }}</td>
			</tr>
			<tr>
				<td>Incremento de Subred</td>
				<td>{{ data.incremento }}</td>
			</tr>
			<tr>
				<td>Binario</td>
				<td><code>{{ data.binario }}</code></td>
			</tr>
		</table>
	</div>

	{% if subredes %}
	<h2 class="mt-5 mb-3 text-glow" style="color: #60a5fa">
		Subredes Generadas ({{ data.nuevas_subredes }})
	</h2>

	<form method="POST" class="mb-3">
		{% csrf_token %}
		<input
			type="hidden"
			name="ip_input"
			value="{{ data.ip }}/{{ data.prefijo }}" />
		<input
			type="hidden"
			name="subnet_bits"
			value="{{ request.POST.subnet_bits }}" />
		<button
			name="exportar"
			value="csv"
			class="btn btn-outline-primary mx-2 fw-bold">
			CSV
		</button>
		<button
			name="exportar"
			value="excel"
			class="btn btn-outline-warning mx-2 fw-bold">
			Excel
		</button>
	</form>

	<div class="table-responsive">
		<table
			class="table table-dark table-hover w-75 mx-auto shadow"
			style="border-color: #2563eb">
			<tr style="background-color: rgba(46, 160, 67, 0.4)">
				<th>#</th>
				<th>Red</th>
				<th>Máscara</th>
				<th>Prefijo</th>
				<th>Broadcast</th>
				<th>Rango</th>
				<th>Hosts</th>
			</tr>
			{% for s in subredes %}
			<tr>
				<td>{{ s.num }}</td>
				<td style="color: #60a5fa">{{ s.network }}</td>
				<td style="color: #a78bfa">{{ s.mascara }}</td>
				<td style="color: #38bdf8">{{ s.prefijo }}</td>
				<td style="color: #f87171">{{ s.broadcast }}</td>
				<td style="color: #34d399">{{ s.rango }}</td>
				<td>{{ s.hosts }}</td>
			</tr>
			{% endfor %}
		</table>
	</div>

	<h3 class="mt-5" style="color: #60a5fa">Visualización de Hosts por Subred</h3>
	<canvas id="chartSubnets" width="400" height="150"></canvas>

	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
		const ctx = document.getElementById('chartSubnets');
		const dataHosts = [{% for s in subredes %}{{ s.hosts }},{% endfor %}];
		new Chart(ctx, {
			type: 'bar',
			data: {
				labels: [{% for s in subredes %}'Subred {{ s.num }}',{% endfor %}],
				datasets: [{
					label: 'Hosts por Subred',
					data: dataHosts,
					backgroundColor: '#1066f0ff',
					borderColor: '#3b82f6',
					borderWidth: 2
				}]
			},
			options: {
				scales: {
					y: {
						beginAtZero: true,
						type: dataHosts.some(v => v > 1000000) ? 'logarithmic' : 'linear',
						title: { display: true, text: 'Cantidad de Hosts' }
					}
				},
				plugins: { legend: { display: false } }
			}
		});
	</script>
	{% endif %} {% endif %}
</div>

<!-- ✅ Glow Animation & Validación IPv4 / IPv6 -->
<style>
	.text-glow {
		text-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
		letter-spacing: 1px;
	}
	@keyframes glow-green {
		0%,
		100% {
			text-shadow: 0 0 6px #2ea043, 0 0 12px #2ea043;
		}
		50% {
			text-shadow: 0 0 18px #2ea043, 0 0 30px #2ea043;
		}
	}
	@keyframes glow-blue {
		0%,
		100% {
			text-shadow: 0 0 6px #1e90ff, 0 0 12px #1e90ff;
		}
		50% {
			text-shadow: 0 0 18px #1e90ff, 0 0 30px #1e90ff;
		}
	}
	.glow-green {
		animation: glow-green 1.5s infinite alternate;
	}
	.glow-blue {
		animation: glow-blue 1.5s infinite alternate;
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		const input = document.querySelector('input[name="ip_input"]');
		const feedback = document.getElementById("ip-valid");

		function validarIP(valor) {
			valor = valor.trim().replace(/\s+/g, "");
			const ipv4 =
				/^((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\/(3[0-2]|[12]?\d|\d)$/;
			const ipv6 =
				/^(([0-9A-Fa-f]{1,4}:){1,7}([0-9A-Fa-f]{1,4}|:)|(::))\/(12[0-8]|1[01][0-9]|[0-9]{1,2})$/;
			if (ipv4.test(valor)) return "ipv4";
			if (ipv6.test(valor)) return "ipv6";
			return null;
		}

		input.addEventListener("input", () => {
			let valor = input.value.trim().replace(/\s+/g, "");
			feedback.classList.remove("glow-green", "glow-blue");

			if (!valor) {
				feedback.textContent = "";
				return;
			}
			const tipo = validarIP(valor);
			if (tipo === "ipv4") {
				feedback.innerHTML = " Dirección IPv4 válida —  Modo IPv4 activo";
				feedback.style.color = "#1e90ff";
				feedback.classList.add("glow-green");
			} else if (tipo === "ipv6") {
				feedback.innerHTML = " Dirección IPv6 válida  —  Modo IPv6 activo";
				feedback.style.color = "#1e90ff";
				feedback.classList.add("glow-blue");
			} else {
				feedback.innerHTML = "❌ Formato no válido (usa /24 o /64, etc.)";
				feedback.style.color = "#f87171";
			}
		});
	});
</script>
{% endblock %}
